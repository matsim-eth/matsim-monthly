language: java
jdk: oraclejdk8
addons:
  apt:
    packages:
      - oracle-java8-installer    # https://github.com/travis-ci/travis-ci/issues/3259
install: true
stages:
    - prepare
    - package
    - test
    - deploy
script:
    - test -e skip_build || (mvn install --also-make --projects ${MODULE} -DskipTests && cd ${TRAVIS_BUILD_DIR}/${MODULE} && mvn failsafe:integration-test --batch-mode -Dmaven.test.redirectTestOutputToFile -Dmatsim.preferLocalDtds=true --fail-at-end)
    - test -e skip_build || (cd $TRAVIS_BUILD_DIR/matsim/matsim && mvn deploy -B -DskipTests=true --settings=$TRAVIS_BUILD_DIR/settings.xml)
jobs:
  include:
    - stage: package
      script: mvn package --batch-mode -Dmaven.test.redirectTestOutputToFile -Dmatsim.preferLocalDtds=true --fail-at-end
    - stage: deploy
      script:
          - test -e skip_build || (cd $TRAVIS_BUILD_DIR/matsim/matsim && mvn deploy -B -DskipTests=true --settings=$TRAVIS_BUILD_DIR/settings.xml)
          - test -e skip_build || (cd $TRAVIS_BUILD_DIR/matsim/contribs && mvn deploy -B -DskipTests=true --settings=$TRAVIS_BUILD_DIR/settings.xml)
          - test -e skip_build || (curl --user $BINTRAY_USER:$BINTRAY_PASSWORD -X POST https://api.bintray.com/content/matsim-eth/matsim/matsim/`cat version.txt`/publish)
    - stage: prepare
          - git clone --depth 1 https://github.com/matsim-org/matsim.git
          - bash prepare.sh
#script:
#  - git clone --depth 1 https://github.com/matsim-org/matsim.git
#  - bash prepare.sh
#  - test -e skip_build || (cd $TRAVIS_BUILD_DIR/matsim && mvn install -B -Dmaven.test.redirectTestOutputToFile -Dmatsim.preferLocalDtds=true --fail-at-end)
#  - test -e skip_build || (cd $TRAVIS_BUILD_DIR/matsim/matsim && mvn deploy -B -DskipTests=true --settings=$TRAVIS_BUILD_DIR/settings.xml)
#  - test -e skip_build || (cd $TRAVIS_BUILD_DIR/matsim/contribs && mvn deploy -B -DskipTests=true --settings=$TRAVIS_BUILD_DIR/settings.xml)
#  - test -e skip_build || (curl --user $BINTRAY_USER:$BINTRAY_PASSWORD -X POST https://api.bintray.com/content/matsim-eth/matsim/matsim/`cat version.txt`/publish)
#cache:
#  directories:
#  - $HOME/.m2
